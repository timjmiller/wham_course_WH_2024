---
title:  "Reference points and Projections"
subtitle: ""
author: "Tim Miller<br>NOAA Fisheries, NEFSC<br> 2024-06-06"
output:
  xaringan::moon_reader:
    self_contained: true
    css: ["xaringan-themer_16_9.css", "slides-style_TMB201.css"]
    lib_dir: libs
    nature:
      ratio: '16:9'
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

layout: true

.footnote[U.S. Department of Commerce | National Oceanic and Atmospheric Administration | National Marine Fisheries Service]


<style type="text/css">

code.cpp{
  font-size: 14px;
}
code.r{
  font-size: 14px;
}


</style>

```{css, echo=FALSE}
pre {
  max-height: 250px; /*changes height of chunk output box*/
  max-width: 800px; /*changes width of chunk output box*/
  overflow-y: auto; /* auto will add vertical scroll bar when necessary */
}

```
```{r set-options, include = FALSE}
options(width = 50)
```

```{r xaringan-tile-view, echo=FALSE}
# this gives you a tile navigation if you type "O" at any time
#xaringanExtra::use_tile_view()
```

---

# Outline <br>

* Using `basic_info` argument to `prepare_wham_input`
* Using different reference point configuration tools
* Using `project_wham`
* Using different projection options
---

# Reference point options

Configuring reference point calculations and projections is probably the most complicated and messy part of WHAM
* WHAM calculates reference points both 
    * annually (in model and projection years) 
    * under prevailing conditions (`static` in the names of the reported output)
* Annual SPR- and MSY-based reference points use annual inputs to SSB and yield per recruit calculations, but there are different options to treat recruitment in different ways for SSB and yield at SPR-based F (e.g., F40).
* For prevailing reference points, the user can specify which year(s) to average over for inputs to SSB/R and Y/R and how recruitment is treated.

---

# Reference point options

The `basic_info` argument to `prepare_wham_input` has these elements to configure SPR-based reference points.
* `basic_info$percentSPR`: percentage (0-100) of unfished SSB/R to use for SPR-based reference points (0-100)
* `basic_info$XSPR_input_average_years`: which years to average inputs to per recruit calculation (selectivity, M, WAA, maturity) for prevailing MSY- and SPR-based reference points. Default is last 5 years.
* `basic_info$XSPR_R_avg_yrs`: which years to average annual recruitments for SSB and Yield at SPR-based F. Default is all data years.
* `basic_info$XSPR_R_opt`: whether to use annual estimated or expected recruitments. 
    * Expected recruitment is constant over years without SR model
---

# Reference point examples
```{r, include = FALSE}
library("wham", lib.loc = "c:/work/wham/old_packages/lab")
```
Fit a model

```{r}
```

---

# Projection options

Relevant arguments to `basic_info`
* `basic_info$XSPR_input_average_years`: is used for both prevailing FXSPR and FMSY and that which is used in projections.

`proj.opts` argument to `project_wham` and `prepare_projection`
* `$n.yrs`: number of projection years
* `$use.FXSPR`: whether to use prevailing SPR-based F
* `$use.FMSY`: whether to use prevailing FMSY (when possible)
* `$percentFXSPR`: same as `basic_info` and redefines it.
* `$percentFMSY`: same as `basic_info` and redefines it.
* `$use.last.F`: whether to use terminal F estimate (and uncertainty)
* `$use.avg.F`: whether to use average of annual F estimates (years defined by `avg.yrs`)
* `$avg.yrs` (vector) specify which years to average over for calculating reference points or average F. Default = last 5 model years.
    * Will redefine anything defined in `prepare_wham_input`
* `$avg.rec.yrs`: specify which years to calculate the mean and sd for the normal distribution of log-recruitment in projections. Default = all model years. Only used when recruitment is estimated as fixed effects (SCAA).

---

# Projection options

`proj.opts` argument to `project_wham` and `prepare_projection` (continued)

* `$proj_mature` user-supplied maturity for the projection years. Overrides averaging over years
* `$proj_waa`} user-supplied weight-at-age for the projection years. Overrides averaging over years
* `$proj_R_opt`: (integer)
    * 1: continue any RE processes for recruitment, 
    * 2: make projected recruitment consistent with average recruitment in SPR reference points and cancel any bias correction for NAA in projection years.
* `$proj.F` (vector) user-specified annual Fs to use in projections 
* `$proj.catch` (vector), user-specified annual catches to use in projections (wham determines F internally)
* `$proj_F_opt`: Overrides any of the above specifications. (vector), integers specifying how to configure each year of the projection: 
    * 1: use terminal F
    * 2: use average F
    * 3: use SPR-based F
    * 4: use specified F
    * 5: use specified catch 
    * 6: use Fmsy
* `$proj_Fcatch`: (vector), catch or F values to use each projection year. Overrides any specifications of `proj.F` or `proj.catch`.

---

# Projection options

`proj.opts` argument to `project_wham` and `prepare_projection` (continued)

* `$cont.ecov` whether to continue environmental covariate process for projections. Default = TRUE.
* `$use.last.ecov` whether to use terminal year ecov for projections.
* `$cont.M.re`: whether to continue M random effects for projections. Default = FALSE.
* `$cont.move.re`: whether to continue any movement random effects for projections. Default = FALSE.

# Projection examples

project off of model m_2

```{r}
```
